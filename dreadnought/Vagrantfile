# vi: set ft=ruby:

require('etc')

username  = Etc.getlogin
ssh_key = File.read("/home/#{username}/.ssh/id_rsa.pub")

class VM
  attr_accessor :hostname, :box, :cpus, :memory, :provisioner
  def initialize(options ={})
    self.hostname = options[:hostname]
    self.box = options[:box] || 'ubuntu/xenial64'
    self.cpus = options[:cpus] || '1'
    self.memory = options[:memory] || '512'
    self.provisioner = options[:provisioner] || "./#{options[:hostname]}/#{options[:hostname]}_config.sh"
  end
end

nodes  = [
  VM.new(hostname: 'lb1'), # option to use specific path with provisioner: path/to/file
  VM.new(hostname: 'web1'),
  VM.new(hostname: 'web2'),
  VM.new(hostname: 'data'),
]

Vagrant.configure("2") do |config|
  if Vagrant.has_plugin?("vagrant-vbguest")
    config.vbguest.auto_update = false
  end
  nodes.each do |node|
    config.vm.define node.hostname do |node_config|
      node_config.vm.box = node.box
      node_config.vm.hostname = node.hostname
      node_config.vm.network :public_network
      node_config.vm.synced_folder ".", "/vagrant", disabled: true
      node_config.vm.provider :virtualbox do |vbox|
        vbox.name = node.hostname
        vbox.memory = node.memory
        vbox.cpus = node.cpus
      end
      node_config.vm.provision "shell", inline: <<-SHELL
        apt update -y
        useradd -m -s /bin/bash -G sudo #{username}
        echo "#{username} ALL=(ALL) NOPASSWD:ALL" >  /etc/sudoers.d/#{username}
        mkdir -p /home/#{username}/.ssh/
        echo "#{ssh_key}" > /home/#{username}/.ssh/authorized_keys
      SHELL
      node_config.vm.provision "shell", path: node.provisioner
    end
  end
end

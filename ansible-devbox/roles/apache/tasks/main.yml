---
- name: Install Apache2
  apt:
    name: apache2
    state: present
    update_cache: True

- name: Enable modules
  apache2_module:
    name: "{{ item }}"
    state: present
  with_items:
    - proxy
    - proxy_http
    - proxy_wstunnel
    - rewrite
    - ssl
  notify:
    - restart apache2

- block:
  - name: Create SSL Dir
    file:
      path: /etc/apache2/ssl
      state: directory
  - name: Generate Cert
    shell: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/apache2/ssl/apache.key -out /etc/apache2/ssl/apache.crt -subj "/C=US/ST=OR/L=Portland/O= /OU= /CN= "
    args:
      creates: /etc/apache2/ssl/apache.crt
  when: ssl_cert == "self_signed" and ssl_cert is defined

- name: Generate VirtualHosts
  template:
    src: "{{ item }}"
    dest: "/etc/apache2/sites-available/{{ item | basename | regex_replace('.conf', '')}}.{{ domain }}.conf"
  with_fileglob:
    - "../templates/*.conf"
